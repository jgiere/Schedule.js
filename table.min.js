/*
	Copyright (C) 2018  Johannes Giere

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.
*/

'use strict';class Table{constructor(elementKeys=[],options={},callback){this._Elements=[];this._ElementKeys=elementKeys;this._Template=null;this._View=null;if(options['elements']!==undefined&&options['templateUrl']!==undefined){this._Elements=options['elements'];this.loadTemplate(options['templateUrl'],callback);}else if(options['elements']==null&&options['templateUrl']==null){this.loadHtml();this.parseTemplate();if(callback!==undefined){callback(this);}}else{console.error('Cannot load template url, parse template or find your specified template.');}}get Elements(){return this._Elements;}get ElementKeys(){return this._ElementKeys;}get Template(){return this._Template;}get View(){return this._View;}loadHtml(){let section=document.getElementsByClassName('repeat')[0];let collection=[];let template='';let rows;if(section.tagName==='TABLE'){rows=section.getElementsByTagName('tr');template='<table class="repeat">';template+='<tr>';for(let i=0;i<this.ElementKeys.length;i++){template+='<td>';template+='{$'+this.ElementKeys[i]+'$}';template+='</td>';}template+='</tr>';template+='</table>';for(let i=0;i<rows.length;i++){let element={};for(let u=0;u<this.ElementKeys.length;u++){if(rows[i].getElementsByClassName(this.ElementKeys[u]).length===1){element[this.ElementKeys[u]]=rows[i].getElementsByClassName(this.ElementKeys[u])[0].textContent;}}collection[i]=element;}}else if(section.tagName==='UL'){rows=section.getElementsByTagName('li');template='<ul class="repeat ';for(let i=0;i<section.classList.length;i++){template+=section.classList[i]+' ';}template+='">';for(let i=0;i<this.ElementKeys.length;i++){template+='<li>';template+='{$'+this.ElementKeys[i]+'$}';template+='</li>';}template+='</ul>';for(let i=0;i<rows.length;i++){let element={};for(let u=0;u<this.ElementKeys.length;u++){element[this.ElementKeys[u]]=rows[i].children[0].textContent;}collection[i]=element;}}this._Template=template;this._Elements=collection;}loadTemplate(url,callback){let httpRequest;if(window.XMLHttpRequest){httpRequest=new XMLHttpRequest();}else if(window.ActiveXObject){httpRequest=new ActiveXObject("Microsoft.XMLHTTP");}let self=this;httpRequest.onreadystatechange=function(){if(httpRequest.readyState===4){self._Template=httpRequest.responseText;self.parseTemplate();if(callback!==undefined){callback(self);}}};httpRequest.open("GET",url,true);httpRequest.setRequestHeader('Content-Type','application/x-www-form-urlencoded');httpRequest.send(null);}parseTemplate(elements=null){if(elements===null){elements=this.Elements;}let pos;let lastpos;let types=[];for(let i=0;i<this.Template.length;i){pos=this.Template.indexOf('{$',i);if(pos!==-1){pos+=2;lastpos=this.Template.indexOf('$}',i);types.push(this.Template.substr(pos,this.Template.length-pos-(this.Template.length-lastpos)));i=lastpos+2;}else{i=this.Template.length;}}let repeatSection;for(let i=0;i<this.Template.length;i){pos=this.Template.indexOf('class="');if(pos!==-1){pos+=7;lastpos=this.Template.indexOf('"',pos);let cssClasses=this.Template.substr(pos,this.Template.length-pos-(this.Template.length-lastpos));let index=cssClasses.indexOf('repeat');if(index!==-1){const templateShort=this.Template.substr(0,pos)+cssClasses.replace('repeat','')+this.Template.substr(pos+cssClasses.length);let beginn=templateShort.substr(0,pos).lastIndexOf('<')+1;let laenge=templateShort.substr(beginn,templateShort.length-beginn).indexOf(' ');let tag=templateShort.substr(beginn,laenge);laenge=templateShort.substr(beginn,templateShort.length-beginn).indexOf('</'+tag+'>')+4+tag.length;repeatSection={'start':beginn-1,'length':laenge,'text':templateShort.substr(beginn-1,laenge)};i+=lastpos.length;}}else{i=this.Template.length;}}let view;if(repeatSection!=null){view=this.Template.substr(0,repeatSection.start)+this.Template.substr(repeatSection.start+repeatSection.length);let pos=repeatSection.start;for(let i=0;i<elements.length;i++){let part=repeatSection.text;for(let index=0;index<this.ElementKeys.length;index++){part=part.replace('{$'+this.ElementKeys[index]+'$}',elements[i][this.ElementKeys[index]]);}view=view.substr(0,pos)+part+view.substr(pos);pos+=part.length;}}this._View=view;return this.View;}search(phrase,property){let result=[];if(property!=null){for(let i=0;i<this.Elements.length;i++){let index=this.Elements[i][property].search(phrase);if(index!==-1){result.push(this.Elements[i]);}}}else{for(let i=0;i<this.Elements.length;i++){const element=this.Elements[i];for(let u=0;u<this.ElementKeys.length;u++){if(typeof element[this.ElementKeys[u]]!=="undefined"){let index=element[this.ElementKeys[u]].toLowerCase().search(phrase.toLowerCase());if(index!==-1){result.push(element);u+=this.ElementKeys.length;}}}}}return result;}redrawView(elements=null){if(elements===null){elements=this.Elements;}return this.parseTemplate(elements);}sort(elements=null,property,options){if(elements===null){elements=this.Elements;}if(property!=null&&options.hasOwnProperty('asc')&&options.hasOwnProperty('type')){if(options.type==='date'||options.type==='time'||options.type==='datetime'){options.type='datetime';}else if(options.type==='string'){}else{options.type=false;}if(options.type){let collection=JSON.parse(JSON.stringify(elements));let item;let sortFinished=false;while(!sortFinished){sortFinished=true;for(let i=0;i<collection.length&&i+1<collection.length;i++){if(options.type==='datetime'){if(options.asc){if(collection[i][property]>collection[i+1][property]){item=collection[i];collection[i]=collection[i+1];collection[i+1]=item;sortFinished=false;}}else{if(collection[i][property]<collection[i+1][property]){item=collection[i];collection[i]=collection[i+1];collection[i+1]=item;sortFinished=false;}}}}}return collection;}else{return[];}}else{return[];}}filter(filterFunction,keyType){let collection=[];for(let i=0;i<this.Elements.length;i++){if(filterFunction(this.Elements[i][keyType])){collection.push(this.Elements[i]);}}return collection;}}